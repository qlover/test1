<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>视差滚动</title>
	<link rel="stylesheet" href="reset.css">
	<link rel="stylesheet" href="style.css" />
</head>
<body class="noselectstart">
	
	<!-- 视图 -->
	<div class="cont noselectstart">
		<!-- 滚动 -->
        <ul class="slider">
            <li data-target="1" class="slide slide1"><div class="darkbg darkbg1"></div></li>
            <li data-target="2" class="slide slide2"><div class="darkbg darkbg2"></div></li>
            <li data-target="3" class="slide slide3"><div class="darkbg darkbg3"></div></li>
            <li data-target="4" class="slide slide4"><div class="darkbg darkbg4"></div></li>
            <li data-target="5" class="slide slide5"><div class="darkbg darkbg5"></div></li>
        </ul>
		<!-- 点 -->
		<ul class="drop">
			<li data-target="1" class="drops active"></li>
			<li data-target="2" class="drops"></li>
			<li data-target="3" class="drops"></li>
			<li data-target="4" class="drops"></li>
			<li data-target="5" class="drops"></li>
		</ul>
		<!-- 切换 -->
		<div data-target="prev" class="pn prev"></div>
		<div data-target="next" class="pn next"></div>

	</div>
    <script src="../Lib/jquery-3.1.1.min.js"></script>
    <!-- <script src="main.js"></script> -->
    <script>
 /**
  * 增加其它的快另一些事件
  * 1.增加切换事件
  * 2.增加键盘事件
  * 还额外增加了适应手机端的触屏滑动
  * 
  */
    var $slider = $('.slider');
    var $dir = false;  // 滚动方向
    var current = 1;  //  !* 得到全局的控制指针
    var winw = $(window).width() * 0.3 ;
    var diff = 0;
    var stop = false;

    function timeout(){
        stop = false;
    }

    // 3.!*核心函数
    function pagination(dir) {
        var doing = current - dir;
        stop = true;
        $slider.addClass('animation').css('transform', 'translate3d(-'+ doing * 100 +'%, 0, 0)')
            .find('.darkbg').css('transform', 'translate3d('+ doing * 50 +'%, 0, 0)');
        // console.log('pag:'+current);  // 打印当前指针
    }

    // 向左滚动
    function toLeft(){
        $dir = false;
        if( current >= 5) return ;
        pagination(0);
        setTimeout(timeout, 1000);
        current++;
        bullets(current-1);
    }

    // 向右滚动
    function toRight(){
        $dir = false;
        if( current <= 1) return ;
        pagination(2);
        setTimeout(timeout, 1000);
        current--;
        bullets(current-1);
    }

    // 保持当前状态
    function toDefault(){
        pagination(1);
        setTimeout(timeout, 1000); // 到此，拖动的效果完成了
    }

    // 2.2 选中点
    function bullets(dir){
        $('.drops').eq(dir).addClass('active')
            .siblings().removeClass('active');
        // console.log('dir:'+dir);
    }

    $(document).on('mousedown touchstart', '.slide', function(event) {
        if( stop ) return ;
        var startX = event.pageX;
        var target = $(this).attr('data-target'); // string

        $slider.removeClass('animation');  // !*
        $(document).on('mousemove touchmove', function(event) {
            diff = startX - (event.pageX);
            if( target == 1 && diff < 0 ){
                console.info('不要快速向右拖动');
                return ;
            }
            if( target == 5 && diff >0 ){
                console.info('不要快速向左拖动');
                return ;  
            }



            $slider.css('transform','translate3d(-' + ((current - 1) * 100 + diff / 30) + '%, 0, 0)')
                .find('.darkbg').css('transform','translate3d(' + ((current - 1) * 50 + diff / 60) + '%, 0, 0');
        });

    });
    // 有滚轮事件就不能将该事件放入点击事件里面了，要写出来
    // 否则会冲突滚轮事件
    // *!* 出过错的代码，找了两个小时
    $(document).on('mouseup touchend', function(event) {
        $(document).off('mousemove touchmove');
        if( stop ) return ;
        if (diff >= winw ) {
            toLeft();
        } else if( diff <= -winw) {
            toRight();
        } else {
            toDefault();
        }
    });


    $(document).on('click', '.drops:not(.active)', function(event) {
        var target = $(this).attr('data-target'); // string
        bullets(target-1);
        current = target;
        pagination(1);
    });
    $(document).on('mousewheel DOMMouseScroll', '.cont', function(event) {
        if (stop) {return ;}
        var delta =  // 获取滚轮方向
            event.originalEvent.wheelDelta ||  // 除FF(120 和 -120 )
            event.originalEvent.detail; // FF(3 和 -3)
        if( delta > 0 ) toRight();
        if( delta < 0 ) toLeft();

        
    });

    // 1.切换事件
    $(document).on('click', '.pn', function(event) {
        // 同样点击事件，如果要在这写节流控制
        // 则必须重写方法，这里并不能用点事件的方法
        // if( stop ) return ;
        
        // 获取节点，可以用这个方法也只可以用 hasClass() 方法来取得
        var dir = $(this).attr('data-target');                
        if( dir == 'prev' ) toLeft();
        if( dir == 'next' ) toRight();
    });

    // 2.键盘事件
    $(document).on('keydown', function(event) {
        var key = event.which;
        if (key == 37) toRight();
        if (key == 39) toLeft();
        
    });



    </script>
</body>
</html>